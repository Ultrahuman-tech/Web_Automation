name: Blood Vision Playwright Tests

on:
  workflow_dispatch:
    inputs:
      blood_vision_base_url:
        description: 'Override Blood Vision base URL (e.g. https://stage.example.com)'
        required: false
        default: 'https://ultrahuman.com'
  schedule:
    - cron: '30 4 * * *'

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_JSON_OUTPUT_NAME: test-results/results.json
      PW_TEST_HTML_REPORT_OPEN: never
      PLAYWRIGHT_HTML_REPORT: playwright-report
      BLOOD_VISION_BASE_URL: ${{ github.event.inputs.blood_vision_base_url || 'https://ultrahuman.com' }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Blood Vision Playwright suite
        id: run_tests
        continue-on-error: true
        run: npx playwright test tests/blood-vision/blood-vision-buy-in.spec.ts --project=chromium --workers=2

      - name: Parse Test Results
        id: parse
        if: always()
        run: |
          if [ -f "$PLAYWRIGHT_JSON_OUTPUT_NAME" ]; then
            PASSED=$(node -e "const d=require('./$PLAYWRIGHT_JSON_OUTPUT_NAME');console.log((d.stats?.expected||0)+(d.stats?.flaky||0))")
            FAILED=$(node -e "const d=require('./$PLAYWRIGHT_JSON_OUTPUT_NAME');console.log(d.stats?.unexpected||0)")
            SKIPPED=$(node -e "const d=require('./$PLAYWRIGHT_JSON_OUTPUT_NAME');console.log(d.stats?.skipped||0)")
            TOTAL=$(node -e "const d=require('./$PLAYWRIGHT_JSON_OUTPUT_NAME');console.log(d.stats?.total||0)")
          else
            PASSED=0
            FAILED=0
            SKIPPED=0
            TOTAL=0
          fi
          echo "TESTS_PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "TESTS_FAILED_COUNT=$FAILED" >> $GITHUB_OUTPUT
          echo "TESTS_SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "TESTS_TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          if [ "$FAILED" -gt 0 ]; then
            echo "ANY_FAILED=true" >> $GITHUB_OUTPUT
          else
            echo "ANY_FAILED=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blood-vision-playwright-report
          path: playwright-report

      - name: Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ü©∏ *Blood Vision Tests Summary*\n‚Ä¢ Base URL: ${{ env.BLOOD_VISION_BASE_URL }}\n‚Ä¢ Branch: ${{ github.ref_name }}\n‚Ä¢ By: ${{ github.actor }}\n\n‚úÖ Passed: ${{ steps.parse.outputs.TESTS_PASSED }}\n‚ùå Failed: ${{ steps.parse.outputs.TESTS_FAILED_COUNT }}\n‚ö™ Skipped: ${{ steps.parse.outputs.TESTS_SKIPPED }}\nüìä Total: ${{ steps.parse.outputs.TESTS_TOTAL }}\n\nüîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Report>\n\n${{ steps.parse.outputs.ANY_FAILED == 'true' && ':x: Some tests failed!' || ':white_check_mark: All tests passed!' }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
