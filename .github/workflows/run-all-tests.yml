name: Run All Tests

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Override base URL for all suites (e.g. https://staging.ultrahuman.com/)'
        required: false
        default: 'https://www.ultrahuman.com'
      stacking_base_url:
        description: 'Override stacking base URL (e.g. https://www.ultrahuman.com/)'
        required: false
        default: 'https://www.ultrahuman.com/'
  schedule:
    - cron: '0 2 * * 0' # Weekly â€” Sunday 07:30 IST (02:00 UTC)

jobs:
  ring:
    name: Ring Tests
    uses: ./.github/workflows/playwright.yml
    with:
      ring_base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}
    secrets: inherit

  blood-vision:
    name: Blood Vision Tests
    uses: ./.github/workflows/blood-vision-playwright.yml
    with:
      base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}
    secrets: inherit

  cgm:
    name: CGM Tests
    uses: ./.github/workflows/cgm-playwright.yml
    with:
      base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com/pricing/' }}
    secrets: inherit

  home:
    name: Home Pricing Tests
    uses: ./.github/workflows/home-playwright.yml
    with:
      home_base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com/home/buy/' }}
    secrets: inherit

  smoke:
    name: Smoke Tests
    uses: ./.github/workflows/smoke-playwright.yml
    with:
      base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}
    secrets: inherit

  region:
    name: Region Switcher Tests
    uses: ./.github/workflows/region-switcher-playwright.yml
    with:
      base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}
    secrets: inherit

  redirects:
    name: URL Redirect Tests
    uses: ./.github/workflows/redirects-playwright.yml
    with:
      base_url: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}
    secrets: inherit

  stacking:
    name: Ring Stacking Tests
    uses: ./.github/workflows/stacking-playwright.yml
    with:
      stacking_base_url: ${{ inputs.stacking_base_url || 'https://www.ultrahuman.com/' }}
    secrets: inherit

  summary:
    name: Summary & Slack Notification
    runs-on: ubuntu-latest
    needs: [ring, blood-vision, cgm, home, smoke, region, redirects, stacking]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "# ğŸ§ª All Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Ring | ${{ needs.ring.result == 'success' && 'âœ… Passed' || needs.ring.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blood Vision | ${{ needs.blood-vision.result == 'success' && 'âœ… Passed' || needs.blood-vision.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CGM | ${{ needs.cgm.result == 'success' && 'âœ… Passed' || needs.cgm.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Home Pricing | ${{ needs.home.result == 'success' && 'âœ… Passed' || needs.home.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke | ${{ needs.smoke.result == 'success' && 'âœ… Passed' || needs.smoke.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region Switcher | ${{ needs.region.result == 'success' && 'âœ… Passed' || needs.region.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL Redirects | ${{ needs.redirects.result == 'success' && 'âœ… Passed' || needs.redirects.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ring Stacking | ${{ needs.stacking.result == 'success' && 'âœ… Passed' || needs.stacking.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ§ª *All Tests Summary*\nâ€¢ Base URL: ${{ inputs.base_url || 'https://www.ultrahuman.com' }}\nâ€¢ Stacking Base URL: ${{ inputs.stacking_base_url || 'https://www.ultrahuman.com/' }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ By: ${{ github.actor }}\n\nâ€¢ Ring: ${{ needs.ring.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ Blood Vision: ${{ needs.blood-vision.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ CGM: ${{ needs.cgm.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ Home Pricing: ${{ needs.home.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ Smoke: ${{ needs.smoke.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ Region Switcher: ${{ needs.region.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ URL Redirects: ${{ needs.redirects.result == 'success' && 'âœ…' || 'âŒ' }}\nâ€¢ Ring Stacking: ${{ needs.stacking.result == 'success' && 'âœ…' || 'âŒ' }}\n\nğŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Report>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
